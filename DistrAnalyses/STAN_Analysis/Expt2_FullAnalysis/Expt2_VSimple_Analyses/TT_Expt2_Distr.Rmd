---
title: "Distributional analyses of child/adult turn taking (Lindsay et al, Experiment 2)"
author: "Hugh Rabagliati"
date: "12/15/2016"
output: 
  html_document:
    toc: true
    number_sections: true
    code_folding: hide
    highlight: tango
    theme: spacelab
---

```{r setup, include=FALSE}
library(knitr)
library(papeR)

library(knitr)
library(papeR)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
library(compute.es)
library(metafor)
library(skewt)
library(fitdistrplus)
library(gamlss)
library(gamlss.dist)
library(lme4)
library(ez)
library(jsonlite)
library(ggplot2)
library(gridExtra)
library(plyr)
library(dplyr)
library(doBy)
library(sn)
library(bootstrap)
# From Mike Frank
theta <- function(x,xdata,na.rm=T) {mean(xdata[x],na.rm=na.rm)}
ci.low <- function(x,na.rm=T) {
  mean(x,na.rm=na.rm) - quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,.025,na.rm=na.rm)}
ci.high <- function(x,na.rm=T) {
  quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,.975,na.rm=na.rm) - mean(x,na.rm=na.rm)}

```

# Background

In this study, children and adults answered questions while playing an iPad game. We varied  

* Whether the context of the question made it possible to predict the answer (factor Pred/Unpred).
* Whether the form of the question made it possible to predict the answer (factor Early/Late).
* The interaction of these two factors (i.e., a proper test of whether participants predict during conversation). 
* Whether the answer to the question was Yes/No (to ensure that participants' attend to the questions).

In this analysis, we fit hierarchical Bayesian models to characterize the distribution of reaction times

```{r read_in_tt_data, include=FALSE}
library(retimes)
library(rstan)
library(ggplot2)
library(retimes)
library(rstan)
library(ggplot2)
library(doBy)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
set.seed(123)

ads <- read.csv("exp2_adults.csv")
fives <- read.csv("exp2_fives.csv")
threes <- read.csv("exp2_threes.csv")

ads$Age <- "Adult"
fives$Age <- "Five"
threes$Age <- "Three"

ads$Group <- "Adult"
fives$Group <- "Kids"
threes$Group <- "Kids"

tt <- rbind(ads,threes,fives)
tt$Age <- as.factor(tt$Age)
tt$Subject <- paste(tt$Age,tt$Subject, sep = "")

tt<- subset(tt, RT.ms <= 6000 & RT.ms >= -500)
# I should really try with a lower cutoff. 4s? Done now; doesn't improve fit.
tt$rt <- tt$RT.ms
tt$N_Early <- ifelse(tt$Early.Late == "early",0,1)
tt$N_Pred <- ifelse(tt$Pred == "Pred",0,1)
tt$N_Right <- ifelse(tt$Right.Wrong == "right",0,1)
#tt$N_AgeFive <- model.matrix(~tt$Age)[,2]
#tt$N_AgeThree <- model.matrix(~tt$Age)[,3]
tt$N_AgeFive <- ifelse(tt$Age == "Five",0,1)#model.matrix(~tt$Age)[,2]
tt$N_E_P_Interact <- tt$N_Pred * tt$N_Early
#tt$N_Early_AgeFive_Interact <-  tt$N_Early * tt$N_AgeFive
tt$N_Early_AgeFive_Interact <- tt$N_Early * tt$N_AgeFive
#tt$N_Pred_AgeFive_Interact <- tt$N_Pred * tt$N_AgeFive
tt$N_Pred_AgeFive_Interact <- tt$N_Pred * tt$N_AgeFive
#tt$N_Early_Pred_AgeFive_Interact <- tt$N_Early * tt$N_Pred * tt$N_AgeFive
tt$N_Early_Pred_AgeFive_Interact <- tt$N_Early * tt$N_Pred * tt$N_AgeFive
# tt$rt_scale <- (tt$rt - mean(tt$rt,na.rm = T))/sd(tt$rt, na.rm = T)

```

## Distribution of Respose Times

The graphs below show the distribution of normaliszed RTs across conditions (we exclude trials where participants were incorrect, and participants who produced fewer than 20 datapoints). When information comes early, adults respond reliably faster in predictable contexts (see non-distributional analyses). It is not clear if the same is true for children.
```{r distr_density, echo=FALSE}
summaryBy(rt ~ Subject, data = tt, FUN = length) -> n.trials
tt <- subset(tt, Subject %in% n.trials[n.trials$rt.length >= 20,]$Subject & Accuracy == 1)
tt$rt <- tt$rt + abs(min(tt$rt)) + 0.001

tt$rt <- (tt$rt - mean(tt$rt))/(sd(tt$rt))
tt$scale_character_length <- (tt$CharacterLength.ms - mean(tt$CharacterLength.ms))/(sd(tt$CharacterLength.ms))



ggplot(tt,aes(x=rt,..density..,col=Pred))+ geom_freqpoly(alpha=1,lwd =1.5, bins = 50)+xlab("Response Time (ms)")+facet_wrap(Early.Late ~ Age) + xlim(c(-2,4))
```

# Analysis

An ex-gaussian distribution convolves a normal distribution with an exponential -- this gives it a long and heavy right tail. We aimed to fit an ex-Gaussian to the response time data, comparing adults with children, and hierarchically modeling the mu parameter, the sigma parameter, and the tau parameter. Mu is the mean of the normal and sigma its standard deviation, while tau is the rate of the exponential. We modeled how these varied across conditions, accounting for random subjec intercepts. Informally, our model had the form:

Mu ~ B0 + (B1 * Early) + (B2 * Pred) + (B3 * Right/Wrong) + (B4 * Age) + ... (the full set of interactions) + (1|Subject)   
Sigma ~ B0 + (B1 * Early) + (B2 * Pred) + (B3 * Right/Wrong)+ (B4 * Age) + ... (the full set of interactions) + (1|Subject)  
Tau ~ B0 + (B1 * Early) + (B2 * Pred) + (B3 * Right/Wrong) + (B4 * Age) + ... (the full set of interactions) + (1|Subject)   

However, this model did not converge well for this experiment. Inspection of the figure above shows that, in fact, adult response times did not really follow an ex-Gaussian pattern -- they were considerably more normal. We therefor fit different models to each age group. The children were given an ex-Gaussian model as so:

Mu ~ B0 + (B1 * Early) + (B2 * Pred) +  (B3 * Right/Wrong) + (B4 * Pred : Early) +  (1|Subject)  
Sigma ~ B0 + (B1 * Early) + (B2 * Pred)  + (B3 * Right/Wrong) + (B4 * Pred : Early) +  (1|Subject)   
Tau  ~ B0 + (B1 * Early) + (B2 * Pred)  + (B3 * Right/Wrong) + (B4 * Pred : Early) +  (1|Subject)   

While the adults were fit a Normal model, as below.

Mu ~ B0 + (B1 * Early) + (B2 * Pred) +  (B3 * Right/Wrong) + (B4 * Pred : Early) +  (1|Subject)  
Sigma ~ B0 + (B1 * Early) + (B2 * Pred)  + (B3 * Right/Wrong) + (B4 * Pred : Early) +  (1|Subject)   


## Ex-Gaussian analysis of children


```{r child_model}
tt_kids <- subject(tt, Age != "Adult")
stanDat_full <- list(rt = tt_kids$rt,
                     factor1 = tt_kids$N_Early,
                     factor2 = tt_kids$N_Pred,
                     factor3 = tt_kids$N_Right,
                     factor4 = tt_kids$N_E_P_Interact, 
                     N = nrow(tt_kids), J = nlevels(as.factor(tt_kids$Subject)), Subj = as.integer(as.factor(tt_kids$Subject)))


simple_conds <- stan(file="fixEf_Conds_transf_expt2.stan",
                    data=stanDat_full,
                    chains = 2, iter = 100)

```

```{r print_child_model}
kable(print(simple_conds, pars = c("beta0","beta","beta_s0","beta_s","beta_t0","beta_t"), probs = c(0.025,0.5,0.975)), digits = 2)
```

